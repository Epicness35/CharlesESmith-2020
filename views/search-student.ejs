<!DOCTYPE html>
<html>

<head>
   <% include partials/head %>
</head>

<!-- The core Firebase JS SDK is always required and must be listed first -->
<script src="https://www.gstatic.com/firebasejs/4.13.0/firebase.js"></script>

<script>
   // Your web app's Firebase configuration
   var firebaseConfig = {
      apiKey: "<%= fbConfig.apiKey %>",
      authDomain: "<%= fbConfig.authDomain %>",
      databaseURL: "<%= fbConfig.databaseURL %>",
      projectId: "<%= fbConfig.projectId %>",
      storageBucket: "<%= fbConfig.storageBucket %>",
      messagingSenderId: "<%= fbConfig.messagingSenderId %>",
      appId: "<%= fbConfig.appId %>",
   };
   // Initialize Firebase
   firebase.initializeApp(firebaseConfig);
</script>

<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.4.1/jquery.min.js"></script>
<script type="text/javascript">

   function searchNames(query, box, callback) { //Query delay causing error
      var names = [];
      const ref = firebase.database().ref('students');
      //ref.orderByChild('last').equalTo(query).on("value", function(snapshot) {
      ref.orderByChild('LAST').equalTo(query).once("value").then(function (snapshot) {
         snapshot.forEach(function (child) {
            var info = [child.child("LAST").val(), child.child("FIRST").val(), child.child("MI").val(), child.key];
            names.push(info);
         });
      }).then(function () {
         clearOptions();
         addOptions(names);

         callback(names);
      }, function (error) {
         console.log("Error");
      });

   }

   function fillSelect(names) {
      if (names.length === 0) {
         console.log("failed");
         alert("Name does not exist.");
      }
   }

   function addOptions(options) {
      for (var i = 0; i < options.length; i++) {
         var text = options[i][0] + ", " + options[i][1];
         if (options[i][2]) {
            text += " " + options[i][2];
         }
         var opt = new Option(text, options[i][3]);
         $(opt).html(text);
         $("#resBox").append(opt);
      }
   }

   function clearOptions() {
      $('#resBox')
         .empty()
         .append('<option style="display:none" disabled selected value>Names</option>');
   }

   $(document).ready(function () {
      $('input[name="studentID"]').focus();
      $('#resBox').change(function () {
         $('input[name="studentID"]').val($("#resBox").val());
      });
   });

</script>

<body>
   <% include partials/header %>
   <form action="/ticket-entry">
      <div class="container mt-4 animated fadeIn">
         <div class="row">
            <div class="col-md-3">
            </div>
            <div class="col-md-6">
               <div class="card">
                  <div class="card-header">
                     <div class="card-title">
                        <h5>Search Student by ID or Last Name</h5>
                     </div>
                     <div class="card-text">

                     </div>
                  </div>
                  <div class="card-body">
                     <div class="card-text">
                        <div class="form-group">
                           <label>Student ID</label>
                           <input class="form-control" type="number" name="studentID">
                        </div>
                        <div class="form-group">
                           <label>Last Name</label>
                           <div class="input-group mb-3">
                              <input type="text" class="form-control" name="lastname" aria-label="Recipient's username"
                                 aria-describedby="basic-addon2">
                              <div class="input-group-append">
                                 <button class="btn btn-secondary" type="button"
                                    onclick="Javascript:searchNames(lastname.value, 'resBox', fillSelect);"><i
                                       class="fa fa-search fa-lg"></i></button>
                              </div>
                           </div>
                        </div>
                        <div class="form-group">
                           <label>Names will appear below</label>
                           <select id="resBox" class="names form-control" size="10">
                              <option style="display:none" disabled selected value>Names</option>
                           </select>
                        </div>
                        <div class="form-group text-center">
                           <button class="btn btn-lg btn-secondary float-left" type="button"
                              onclick="window.location.href='/index'">Back</button>
                           <input class="btn btn-lg btn-success" type="submit" value="Submit">
                        </div>
                     </div>
                  </div>
               </div>
            </div>
            <div class="col-md-3">
            </div>
         </div>
      </div>
   </form>

</html>